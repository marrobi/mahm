{% extends 'layout-app.html' %}

{% set hub = "Your health" %}
{% set pageHeading = "Accessibility and language settings" %}
{% set backLink = true %}

{% block beforeContent %}
  <div class="nhsuk-back-link">
    <a class="nhsuk-back-link__link" href="/pages/mybp/">
      <svg class="nhsuk-icon nhsuk-icon__chevron-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" height="24" width="24">
        <path d="M8.5 12c0-.3.1-.5.3-.7l5-5c.4-.4 1-.4 1.4 0s.4 1 0 1.4L10.9 12l4.3 4.3c.4.4.4 1 0 1.4s-1 .4-1.4 0l-5-5c-.2-.2-.3-.4-.3-.7z"></path>
      </svg>
      Back to My BP
    </a>
  </div>
{% endblock %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">

      <!-- PAGE TITLE -->
      {{ dynamicPageTitle({
        logo: data['web'] !== "yes",
        heading: "Accessibility and language settings",
        subtitle: "Customise how you use My BP"
      })}}

      <p class="nhsuk-lede-text">
        Change these settings to make My BP easier to use. Your settings are saved to your NHS App account.
      </p>

      <form id="accessibility-settings-form" method="post" action="/pages/mybp/accessibility-settings/" novalidate>

        <!-- SECTION - TEXT AND DISPLAY -->
        {{ nhsappSectionHeading({
          headingText: "Text and display"
        }) }}

        <!-- Text size -->
        <div class="nhsuk-form-group">
          {{ select({
            id: "text-size",
            name: "text-size",
            label: {
              text: "Text size"
            },
            hint: {
              text: "Choose your preferred text size for better readability"
            },
            items: [
              {
                value: "standard",
                text: "Standard",
                selected: (data['text-size'] or 'standard') === "standard"
              },
              {
                value: "large",
                text: "Large",
                selected: data['text-size'] === "large"
              },
              {
                value: "extra-large",
                text: "Extra large",
                selected: data['text-size'] === "extra-large"
              }
            ]
          }) }}
        </div>

        <!-- Bold text -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "bold-text",
            name: "bold-text",
            items: [
              {
                value: "enabled",
                text: "Bold text",
                hint: {
                  text: "Make all text bold for improved contrast and readability"
                },
                checked: data['bold-text'] === "enabled"
              }
            ]
          }) }}
        </div>

        <!-- SECTION - NAVIGATION AND INTERACTION -->
        {{ nhsappSectionHeading({
          headingText: "Navigation and interaction"
        }) }}

        <!-- Focus indicators -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "focus-indicators",
            name: "focus-indicators",
            items: [
              {
                value: "enabled",
                text: "Enhanced focus indicators",
                hint: {
                  text: "Show stronger visual focus indicators when navigating with keyboard"
                },
                checked: data['focus-indicators'] === "enabled"
              }
            ]
          }) }}
        </div>

        <!-- Button labels -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "button-labels",
            name: "button-labels",
            items: [
              {
                value: "enabled",
                text: "Enhanced button labels",
                hint: {
                  text: "Show clearer and more descriptive labels on buttons and links"
                },
                checked: data['button-labels'] === "enabled"
              }
            ]
          }) }}
        </div>

        <!-- Reduce motion -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "reduce-motion",
            name: "reduce-motion",
            items: [
              {
                value: "enabled",
                text: "Reduce motion",
                hint: {
                  text: "Turn off animations and movement effects (follows system preference)"
                },
                checked: data['reduce-motion'] === "enabled"
              }
            ]
          }) }}
        </div>

        <!-- Touch target size -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "touch-targets",
            name: "touch-targets",
            items: [
              {
                value: "enabled",
                text: "Larger touch targets",
                hint: {
                  text: "Make buttons and links easier to tap on touchscreen devices"
                },
                checked: data['touch-targets'] === "enabled"
              }
            ]
          }) }}
        </div>

        <!-- SECTION - LANGUAGE AND COMMUNICATION -->
        {{ nhsappSectionHeading({
          headingText: "Language and communication"
        }) }}

        <!-- Language picker -->
        <div class="nhsuk-form-group">
          {{ select({
            id: "language",
            name: "language",
            label: {
              text: "Language"
            },
            hint: {
              text: "Choose your preferred language for My BP content and interface"
            },
            items: [
              {
                value: "en",
                text: "English",
                selected: (data['language'] or 'en') === "en"
              },
              {
                value: "cy",
                text: "Cymraeg (Welsh)",
                selected: data['language'] === "cy"
              },
              {
                value: "ur",
                text: "اردو (Urdu)",
                selected: data['language'] === "ur"
              },
              {
                value: "bn",
                text: "বাংলা (Bengali)",
                selected: data['language'] === "bn"
              },
              {
                value: "hi",
                text: "हिन्दी (Hindi)",
                selected: data['language'] === "hi"
              },
              {
                value: "pa",
                text: "ਪੰਜਾਬੀ (Punjabi)",
                selected: data['language'] === "pa"
              },
              {
                value: "pl",
                text: "Polski (Polish)",
                selected: data['language'] === "pl"
              },
              {
                value: "so",
                text: "Soomaali (Somali)",
                selected: data['language'] === "so"
              },
              {
                value: "ar",
                text: "العربية (Arabic)",
                selected: data['language'] === "ar"
              }
            ]
          }) }}
        </div>

        <!-- Communication support -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "communication-support",
            name: "communication-support",
            items: [
              {
                value: "sign-language",
                text: "British Sign Language (BSL) interpretation",
                hint: {
                  text: "Request BSL interpretation for video consultations when available"
                },
                checked: data['communication-support'] and 'sign-language' in data['communication-support']
              },
              {
                value: "easy-read",
                text: "Easy read format",
                hint: {
                  text: "Use simple language and clear layout for health information"
                },
                checked: data['communication-support'] and 'easy-read' in data['communication-support']
              }
            ]
          }) }}
        </div>

        <!-- SECTION - ALERTS AND NOTIFICATIONS -->
        {{ nhsappSectionHeading({
          headingText: "Alerts and notifications"
        }) }}

        <!-- Screen reader announcements -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "screen-reader",
            name: "screen-reader",
            items: [
              {
                value: "enhanced",
                text: "Enhanced screen reader support",
                hint: {
                  text: "Provide additional context and descriptions for screen reader users"
                },
                checked: data['screen-reader'] === "enhanced"
              }
            ]
          }) }}
        </div>

        <!-- Audio cues -->
        <div class="nhsuk-form-group">
          {{ checkboxes({
            idPrefix: "audio-cues",
            name: "audio-cues",
            items: [
              {
                value: "enabled",
                text: "Audio confirmation sounds",
                hint: {
                  text: "Play sounds to confirm when actions are completed successfully"
                },
                checked: data['audio-cues'] === "enabled"
              }
            ]
          }) }}
        </div>

        <!-- SAVE BUTTON -->
        <div class="nhsuk-form-group">
          {{ button({
            text: "Save settings",
            classes: "nhsuk-button--primary"
          }) }}
        </div>

        <!-- RESET LINK -->
        <details class="nhsuk-details">
          <summary class="nhsuk-details__summary">
            <span class="nhsuk-details__summary-text">
              Reset to default settings
            </span>
          </summary>
          <div class="nhsuk-details__text">
            <p>This will reset all your accessibility and language settings back to the default options.</p>
            <p>
              <a href="/pages/mybp/accessibility-settings/reset" class="nhsuk-link">
                Reset all settings to default
              </a>
            </p>
          </div>
        </details>

      </form>

    </div>
  </div>
{% endblock %}

{% block pageScripts %}
  <script>
    // Enhanced accessibility settings with proper focus management
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('accessibility-settings-form');
      
      // Add proper ARIA labels and descriptions
      enhanceFormAccessibility();
      
      // Add form validation
      form.addEventListener('submit', function(e) {
        validateAndSaveSettings(e);
      });
      
      // Add keyboard navigation support
      addKeyboardSupport();
    });

    function enhanceFormAccessibility() {
      // Add fieldset and legend elements for better grouping
      const sections = document.querySelectorAll('[data-module="nhsapp-section-heading"]');
      sections.forEach(function(section) {
        const heading = section.querySelector('h2');
        if (heading) {
          // Add role and aria-labelledby for better screen reader support
          const nextElement = section.nextElementSibling;
          if (nextElement) {
            nextElement.setAttribute('role', 'group');
            nextElement.setAttribute('aria-labelledby', heading.id || 'section-' + Math.random().toString(36).substr(2, 9));
          }
        }
      });
      
      // Enhance form controls with better descriptions
      const formGroups = document.querySelectorAll('.nhsuk-form-group');
      formGroups.forEach(function(group) {
        const input = group.querySelector('input, select');
        const hint = group.querySelector('.nhsuk-hint');
        if (input && hint) {
          const hintId = 'hint-' + Math.random().toString(36).substr(2, 9);
          hint.id = hintId;
          input.setAttribute('aria-describedby', hintId);
        }
      });
    }

    function validateAndSaveSettings(e) {
      // Basic validation - ensure at least one setting is configured
      const formData = new FormData(e.target);
      const hasSettings = Array.from(formData.entries()).some(([key, value]) => value && value !== 'standard');
      
      if (!hasSettings) {
        // Show success message anyway - default settings are valid
        console.log('Using default settings - this is fine');
      }
      
      console.log('Saving accessibility settings...', {
        textSize: formData.get('text-size'),
        language: formData.get('language'),
        communicationSupport: formData.getAll('communication-support')
      });
    }

    function addKeyboardSupport() {
      // Ensure all interactive elements are keyboard accessible
      const interactiveElements = document.querySelectorAll('input, select, button, a');
      interactiveElements.forEach(function(element) {
        // Add focus styles if not already present
        if (!element.classList.contains('nhsuk-button') && !element.classList.contains('nhsuk-link')) {
          element.addEventListener('focus', function() {
            this.style.outline = '3px solid #ffb81c';
            this.style.outlineOffset = '0';
          });
          
          element.addEventListener('blur', function() {
            this.style.outline = '';
            this.style.outlineOffset = '';
          });
        }
      });
    }
  </script>
{% endblock %}